# Firestore Setup Documentation

This document describes the Firestore database structure, security rules, and setup procedures for the Darshan Booking system.

## Collections Structure

### 1. Bookings Collection (`/bookings`)

Stores user booking information with the following structure:

```typescript
interface BookingDocument {
  userId: string;        // Firebase Auth user ID
  slotTime: Timestamp;   // Firebase Timestamp for the booking slot
  status: string;        // 'confirmed' | 'cancelled' | 'completed'
  createdAt: Timestamp;  // Document creation timestamp
  updatedAt: Timestamp;  // Last update timestamp
}
```

**Document ID**: Auto-generated by Firestore
**Indexes**: See `firestore.indexes.json` for composite indexes

### 2. Time Slots Collection (`/timeSlots`)

Stores available time slots with capacity tracking:

```typescript
interface TimeSlotDocument {
  date: Timestamp;       // Date of the slot
  time: string;          // Time in HH:MM format (e.g., "10:00")
  capacity: number;      // Maximum bookings for this slot
  booked: number;        // Current number of bookings
  available: boolean;    // Computed availability status
  createdAt: Timestamp;  // Document creation timestamp
  updatedAt: Timestamp;  // Last update timestamp
}
```

**Document ID**: Format `YYYY-MM-DD-HH-MM` (e.g., "2024-03-15-10-00")
**Indexes**: See `firestore.indexes.json` for composite indexes

## Security Rules

The Firestore security rules implement the following access controls:

### Authentication Requirements
- All operations require user authentication
- Users can only access their own booking data
- Time slots are readable by all authenticated users

### Booking Rules
- **Create**: Users can create bookings for themselves with validation:
  - Booking must be in the future
  - Booking must be within 30 days advance limit
  - Booking must be at least 2 hours in advance
  - User can only book for their own user ID
- **Read**: Users can only read their own bookings
- **Update**: Users can only cancel their own confirmed bookings
- **Delete**: Prevented for audit trail purposes

### Time Slot Rules
- **Create**: Allowed for authenticated users (typically admin/system)
- **Read**: All authenticated users can read time slots
- **Update**: Limited to booked count and availability fields with validation:
  - Booked count cannot exceed capacity
  - Booked count cannot decrease (prevents overbooking)
- **Delete**: Prevented to maintain data integrity

### Query Rules
- Users can query their own bookings with userId filter
- All authenticated users can query time slots
- Unauthenticated access is denied for all collections

## Indexes Configuration

The following composite indexes are configured for optimal query performance:

### Bookings Collection Indexes
1. `userId` (ASC) + `status` (ASC) + `createdAt` (DESC)
   - For querying user bookings by status, ordered by creation date
2. `userId` (ASC) + `slotTime` (ASC)
   - For querying user bookings by time slot
3. `slotTime` (ASC) + `status` (ASC)
   - For system queries on bookings by time and status

### Time Slots Collection Indexes
1. `date` (ASC) + `available` (ASC) + `time` (ASC)
   - For querying available slots on a specific date
2. `date` (ASC) + `time` (ASC)
   - For querying all slots on a specific date

## Setup Instructions

### 1. Initialize Firestore Configuration

The Firebase project should be configured with the following files:
- `firestore.rules` - Security rules
- `firestore.indexes.json` - Index configuration
- `firebase.json` - Firebase project configuration

### 2. Deploy Rules and Indexes

```bash
# Deploy Firestore rules
firebase deploy --only firestore:rules

# Deploy Firestore indexes
firebase deploy --only firestore:indexes
```

### 3. Initialize Data Structure

Run the initialization script to create time slots:

```bash
# Using Node.js
node scripts/initializeFirestore.js

# Using ts-node
npx ts-node scripts/initializeFirestore.ts
```

### 4. Validate Security Rules

Test the security rules using the validation script:

```bash
# Run rules validation tests
npx ts-node scripts/validateFirestoreRules.ts
```

## Development and Testing

### Using Firebase Emulators

For local development, use Firebase emulators:

```bash
# Start emulators
firebase emulators:start

# The Firestore emulator will be available at:
# http://localhost:8080 (Firestore)
# http://localhost:4000 (Emulator UI)
```

### Environment Configuration

Ensure your Firebase configuration points to the correct project:

```typescript
// In production
const firebaseConfig = {
  // Your production Firebase config
};

// In development (using emulators)
if (process.env.NODE_ENV === 'development') {
  connectFirestoreEmulator(db, 'localhost', 8080);
}
```

## Data Management

### Time Slot Generation

Time slots are generated automatically for the next 30 days with:
- 30-minute intervals
- Operating hours: 6:00 AM to 8:00 PM
- Default capacity: 50 bookings per slot
- Automatic availability calculation

### Booking Lifecycle

1. **Creation**: User selects date/time, booking created with "confirmed" status
2. **Confirmation**: QR code generated, user receives confirmation
3. **Cancellation**: User can cancel confirmed bookings (status â†’ "cancelled")
4. **Completion**: System marks bookings as "completed" after the slot time

### Capacity Management

- Time slot capacity is tracked in real-time
- Booked count is incremented when bookings are created
- Availability is calculated as `booked < capacity`
- Overbooking is prevented by security rules and application logic

## Monitoring and Maintenance

### Performance Monitoring

Monitor the following metrics:
- Query performance and index usage
- Read/write operations count
- Security rule evaluation time
- Error rates and types

### Regular Maintenance

1. **Archive old bookings**: Move completed bookings older than 6 months to archive collection
2. **Generate future time slots**: Ensure time slots are available for the next 30 days
3. **Monitor capacity**: Adjust slot capacity based on demand patterns
4. **Review security rules**: Regular security audits and rule updates

## Troubleshooting

### Common Issues

1. **Permission Denied Errors**
   - Check user authentication status
   - Verify security rules match the operation
   - Ensure proper userId in booking documents

2. **Index Errors**
   - Deploy missing indexes using `firebase deploy --only firestore:indexes`
   - Check query structure matches available indexes

3. **Capacity Issues**
   - Verify booked count doesn't exceed capacity
   - Check for race conditions in booking creation
   - Implement proper transaction handling

### Error Codes

The system uses specific error codes for different scenarios:
- `permission-denied`: Security rule violation
- `not-found`: Document doesn't exist
- `already-exists`: Duplicate booking attempt
- `resource-exhausted`: Quota limits exceeded

## Security Considerations

### Data Privacy
- User data is isolated by userId
- No cross-user data access
- Audit trail maintained for all operations

### Access Control
- Authentication required for all operations
- Role-based access can be implemented using custom claims
- Time-based access restrictions for booking windows

### Data Validation
- Client-side and server-side validation
- Security rules enforce data integrity
- Input sanitization and type checking

## Best Practices

1. **Use transactions** for operations that modify multiple documents
2. **Implement retry logic** for transient failures
3. **Cache frequently accessed data** (like time slots)
4. **Monitor quota usage** and implement rate limiting
5. **Regular backup** of critical booking data
6. **Test security rules** thoroughly before deployment
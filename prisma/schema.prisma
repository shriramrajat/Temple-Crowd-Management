generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admin_users {
  id           String   @id
  email        String   @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  role         String   @default("admin") @db.VarChar(20)
  createdAt    DateTime @default(now())
}

model bookings {
  id             String    @id
  slotId         String
  name           String    @db.VarChar(100)
  phone          String    @db.VarChar(10)
  email          String    @db.VarChar(255)
  numberOfPeople Int
  qrCode         String
  status         String    @default("confirmed") @db.VarChar(20)
  checkedInAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  slots          slots     @relation(fields: [slotId], references: [id])

  @@index([email])
  @@index([phone])
  @@index([slotId])
  @@index([status])
}

model crowd_snapshots {
  id        String   @id
  zoneId    String   @db.VarChar(50)
  zoneName  String   @db.VarChar(100)
  footfall  Int
  capacity  Int
  timestamp DateTime @db.Timestamptz(6)
  dayOfWeek Int
  hourOfDay Int
  createdAt DateTime @default(now())

  @@index([dayOfWeek, hourOfDay])
  @@index([zoneId, timestamp])
}

model password_reset_tokens {
  id        String    @id
  userId    String
  token     String    @unique @db.VarChar(255)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  users     users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model peak_hour_patterns {
  id          String   @id
  zoneId      String   @db.VarChar(50)
  dayOfWeek   Int
  startHour   Int
  endHour     Int
  avgFootfall Float
  confidence  Float
  updatedAt   DateTime

  @@unique([zoneId, dayOfWeek, startHour])
}

model prediction_cache {
  id             String   @id
  zoneId         String   @db.VarChar(50)
  predictedTime  DateTime @db.Timestamptz(6)
  predictedValue Int
  confidence     Float
  generatedAt    DateTime @default(now())
  expiresAt      DateTime

  @@index([expiresAt])
  @@index([zoneId, predictedTime])
}

model slots {
  id            String          @id
  date          DateTime        @db.Date
  startTime     String          @db.VarChar(5)
  endTime       String          @db.VarChar(5)
  capacity      Int
  bookedCount   Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  bookings      bookings[]
  user_bookings user_bookings[]

  @@index([date, startTime])
}

model sos_alerts {
  id             String    @id
  userId         String?
  userName       String?   @db.VarChar(100)
  userPhone      String?   @db.VarChar(15)
  userEmail      String?   @db.VarChar(255)
  latitude       Float?
  longitude      Float?
  manualLocation String?   @db.VarChar(500)
  message        String?
  emergencyType  String    @db.VarChar(50)
  status         String    @default("pending") @db.VarChar(20)
  resolvedAt     DateTime?
  resolvedBy     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  users          users?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model user_bookings {
  id             String    @id
  userId         String
  slotId         String
  numberOfPeople Int
  qrCode         String
  status         String    @default("confirmed") @db.VarChar(20)
  checkedInAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
  slots          slots     @relation(fields: [slotId], references: [id])
  users          users     @relation(fields: [userId], references: [id])

  @@index([slotId])
  @@index([status])
  @@index([userId])
}

model users {
  id                    String                  @id
  email                 String                  @unique @db.VarChar(255)
  passwordHash          String                  @db.VarChar(255)
  name                  String?                 @db.VarChar(100)
  phone                 String?                 @db.VarChar(15)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  lastLoginAt           DateTime?
  failedLoginCount      Int                     @default(0)
  lockedUntil           DateTime?
  address               String?                 @db.VarChar(500)
  city                  String?                 @db.VarChar(100)
  country               String?                 @default("India") @db.VarChar(100)
  formattedAddress      String?                 @db.VarChar(500)
  latitude              Float?
  longitude             Float?
  pinCode               String?                 @db.VarChar(10)
  placeId               String?                 @db.VarChar(255)
  state                 String?                 @db.VarChar(100)
  role                  UserRole                @default(PILGRIM)
  password_reset_tokens password_reset_tokens[]
  sos_alerts            sos_alerts[]
  user_bookings         user_bookings[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  PILGRIM
  ADMIN
}
